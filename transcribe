#!/Users/student/Desktop/ai+design/Speech-To-Text/.venv/bin/python
#!/usr/bin/env python3
import os
import sys
from dotenv import load_dotenv
import assemblyai as aai
from google_docs_helper import create_doc_with_text
import requests
import time
import argparse

load_dotenv(os.path.join(os.path.dirname(os.path.abspath(__file__)), ".env"))

ASSEMBLYAI_API_KEY = os.getenv('ASSEMBLYAI_API_KEY')
GOOGLE_CLIENT_ID = os.getenv('GOOGLE_CLIENT_ID')
GOOGLE_CLIENT_SECRET = os.getenv('GOOGLE_CLIENT_SECRET')

def transcribe_with_slam(audio_file_path, keyterms_prompt=None):
    base_url = "https://api.assemblyai.com"
    headers = {"authorization": ASSEMBLYAI_API_KEY}

    # Support both local files and URLs
    if audio_file_path.startswith("http://") or audio_file_path.startswith("https://"):
        audio_url = audio_file_path
    else:
        # Upload local file to AssemblyAI
        upload_url = f"{base_url}/v2/upload"
        with open(audio_file_path, "rb") as f:
            upload_response = requests.post(upload_url, headers=headers, files={"file": f})
        if upload_response.status_code != 200:
            print(f"Error uploading file: {upload_response.text}")
            sys.exit(1)
        audio_url = upload_response.json()["upload_url"]

    data = {
        "audio_url": audio_url,
        "speech_model": "slam-1",
    }
    if keyterms_prompt:
        data["keyterms_prompt"] = keyterms_prompt

    response = requests.post(base_url + "/v2/transcript", headers=headers, json=data)
    if response.status_code != 200:
        print(f"Error: {response.status_code}, Response: {response.text}")
        response.raise_for_status()

    transcript_response = response.json()
    transcript_id = transcript_response["id"]
    polling_endpoint = f"{base_url}/v2/transcript/{transcript_id}"

    print("[AssemblyAI] Waiting for transcription to complete...")
    while True:
        transcript = requests.get(polling_endpoint, headers=headers).json()
        if transcript["status"] == "completed":
            print("[AssemblyAI] Transcription complete.")
            return transcript["text"]
        elif transcript["status"] == "error":
            raise RuntimeError(f"Transcription failed: {transcript['error']}")
        else:
            time.sleep(3)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Transcribe audio and upload to Google Docs.")
    parser.add_argument("audio_file_path", help="Path or URL to audio file")
    parser.add_argument("--slam", action="store_true", help="Use slam-1 model with keyterms_prompt")
    parser.add_argument("--keyterms", nargs="*", help="Key terms for keyterms_prompt (slam-1 only)")
    args = parser.parse_args()

    audio_file_path = args.audio_file_path

    if args.slam:
        transcript_text = transcribe_with_slam(audio_file_path, args.keyterms)
    else:
        aai.settings.api_key = ASSEMBLYAI_API_KEY  # Ensure API key is set for SDK
        config = aai.TranscriptionConfig(speaker_labels=True)
        try:
            transcriber = aai.Transcriber()
            transcript = transcriber.transcribe(audio_file_path, config)
            if transcript.status == "error":
                print(f"Transcription failed: {transcript.error}")
                sys.exit(1)
            if hasattr(transcript, 'utterances') and transcript.utterances:
                transcript_text = "\n".join([
                    f"Speaker {utt.speaker}: {utt.text}" for utt in transcript.utterances
                ])
            else:
                transcript_text = transcript.text
            print("[AssemblyAI] Transcription complete.")
        except Exception as e:
            print(f"Error during transcription: {e}")
            sys.exit(1)

    # Google Docs API call
    try:
        doc_title = f"Transcript for {os.path.basename(audio_file_path)}"
        google_doc_link = create_doc_with_text(doc_title, transcript_text)
        if google_doc_link:
            print(f"[Google Docs] Document created: {google_doc_link}")
        else:
            print("[Google Docs] Failed to create document.")
    except Exception as e:
        print(f"Error during Google Docs upload: {e}")
        sys.exit(1)

    print(f"Transcript: {transcript_text}")
    print(f"Google Doc Link: {google_doc_link}") 